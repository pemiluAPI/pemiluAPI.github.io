<!DOCTYPE html>
<html lang="in">
  <head>
    <title>Peta Caleg</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- third-party (vendor) scripts -->
    <script src="js/vendor/d3.v3.min.js"></script>
    <script src="js/vendor/queue.v1.min.js"></script>
    <script src="js/vendor/qs.min.js"></script>

    <script src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;v=3.14&amp;libraries=geometry,places"></script>
    <script src="js/vendor/GeoJSON.min.js"></script>
    <script src="js/vendor/topojson.v1.min.js"></script>

    <script src="js/PetaCaleg.js"></script>

    <link rel="stylesheet" href="css/vendor/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="css/PetaCaleg.css">
  </head>
  <body>
    <div class="container">

      <div id="header">
        <div id="navbar" class="navbar navbar-inverse">
          <div class="container">
            <div class="navbar-header">
              <a class="navbar-brand" href="#">Peta Caleg</a>
            </div>
          </div>
        </div>
      </div>

      <ul id="nav-lembaga" class="nav nav-pills nav-justified">
        <li><a href="#DPD">DPD</a></li>
        <li><a href="#DPR">DPR</a></li>
        <li><a href="#DPRDI">DPRDI</a></li>
      </ul>

      <div id="peta">
      </div>

      <ol id="breadcrumb" class="breadcrumb">
      </ol>

      <div id="content">
      </div>

      <svg class="shared">
        <defs>
          <g id="map-bg"></g>
        </defs>
      </svg>
    </div>
    <script>

      var app,
          resolver = new PetaCaleg.Resolver(),
          api = new PetaCaleg.API({
            key: "7941b0baecd128c4de3a9ae63a85fd2c" // XXX
          }),
          nav = d3.select("#nav-lembaga")
            .selectAll("li")
            .datum(function() {
              return d3.select(this).select("a")
                .attr("href")
                .substr(1);
            }),
          mapBg = "#map-bg",
          mapIcon = new PetaCaleg.MapIcon({
            background: mapBg
          });

      window.addEventListener("load", function init() {
        app = new PetaCaleg.App({
          api: api,
          // the map instance
          map: new PetaCaleg.Map({
            root: "#peta"
          }),
          mapIcon: mapIcon,
          // where the breadcrumb nav lives
          breadcrumb: "#breadcrumb",
          // where to render content (listings + detail views)
          content:    "#content",
          // valid URLs
          routes: [
            "{lembaga}",
            "{lembaga}/provinsi/{provinsi}",
            "{lembaga}/provinsi/{provinsi}/caleg/{caleg}",
            "{lembaga}",
            "{lembaga}/provinsi/{provinsi}/dapil/{dapil}",
            "{lembaga}/provinsi/{provinsi}/dapil/{dapil}/partai/{partai}",
            "{lembaga}/provinsi/{provinsi}/dapil/{dapil}/partai/{partai}/caleg/{caleg}",
          ]
        });

        // whenever the app switches contexts...
        app.on("context", function(context) {
          // update the nav
          nav.classed("active", function(d) {
            return d === context.lembaga;
          });
        });

        // kick it all off
        app.init();

        var get = api.get.bind(api);
        queue()
          .defer(get, "geographic/api/getmap", {
            filename: "nearby_countries.topojson"
          })
          .defer(get, "geographic/api/getmap", {
            filename: "admin-simple.topojson"
          })
          .await(function(error, nearby, admin) {
            if (error) {
              console.warn("unablet to load map background:", error);
              return;
            }

            var bg = d3.select(mapBg);
            bg.append("path")
              .attr("class", "nearby")
              .datum(makeCollection(nearby))
              .attr("d", mapIcon.path);
            bg.append("path")
              .attr("class", "admin")
              .datum(makeCollection(admin))
              .attr("d", mapIcon.path);

            console.info("done drawing map background");

            function makeCollection(topology, key) {
              if (key) {
                return topojson.feature(topology, topology.objects[key]);
              } else {
                var collection = {
                  type: "FeatureCollection",
                  features: []
                };
                for (var key in topology.objects) {
                  var features = topojson.feature(topology, topology.objects[key]).features;
                  collection.features = collection.features.concat(features);
                }
                return collection;
              }
            }
          });
      });

    </script>
  </body>
</html>
